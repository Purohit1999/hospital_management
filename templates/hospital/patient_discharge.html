{% extends 'hospital/patient_base.html' %}
{% load static %}
{% block content %}

<div class="container">
  {% if discharges %}
    {% for discharge in discharges %}
      <div class="invoice-box" id="invoice-box-{{ forloop.counter }}">
        <table>
          <tr class="top">
            <td colspan="2">
              <table>
                <tr>
                  <td class="title">
                    <img src="{% static 'images/hospital-logo.png' %}" alt="Hospital Logo">
                  </td>
                  <td style="text-align:right;">
                    <strong>Admit Date:</strong> {{ discharge.admission_date }}<br>
                    <strong>Release Date:</strong> {{ discharge.discharge_date }}<br>
                    <strong>Days Spent:</strong> {{ discharge.days_spent }}
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <tr class="information">
            <td colspan="2">
              <table>
                <tr>
                  <td>
                    <strong>Patient Name:</strong> {{ patient.user.get_full_name }}<br>
                    <strong>Mobile:</strong> {{ patient.mobile }}<br>
                    <strong>Address:</strong> {{ patient.address }}
                  </td>
                  <td>
                    <strong>Doctor:</strong> {{ discharge.doctor.user.get_full_name }}
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <tr class="heading">
            <td>Disease and Symptoms</td>
            <td></td>
          </tr>
          <tr class="item">
            <td colspan="2">{{ patient.symptoms }}</td>
          </tr>

          <tr class="heading">
            <td>Item</td>
            <td>Price (₹)</td>
          </tr>
          <tr class="item">
            <td>Room Charge</td>
            <td>{{ discharge.room_charge|floatformat:2 }}</td>
          </tr>
          <tr class="item">
            <td>Doctor Fee</td>
            <td>{{ discharge.doctor_fee|floatformat:2 }}</td>
          </tr>
          <tr class="item">
            <td>Medicine Cost</td>
            <td>{{ discharge.medicine_cost|floatformat:2 }}</td>
          </tr>
          <tr class="item">
            <td>Other Charges</td>
            <td>{{ discharge.other_charge|floatformat:2 }}</td>
          </tr>
          <tr class="total">
            <td></td>
            <td>Total: ₹ {{ discharge.total|floatformat:2 }}</td>
          </tr>
        </table>

        <div class="download-print">
          <a href="{% url 'download-pdf' patient.id %}?discharge_id={{ discharge.id }}" title="Download PDF">Download PDF</a>
          <button onclick="printInvoice('{{ forloop.counter }}')">Print Invoice</button>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="not-discharged">
      <h4>You are not yet discharged from the hospital.</h4>
      <p>Your treatment is still ongoing.</p>
      <p>Once discharged, you can view and download your invoices here.</p>
    </div>
  {% endif %}
</div>

<script>
  function printInvoice(id) {
    const invoiceBox = document.getElementById("invoice-box-" + id);
    const printContents = invoiceBox.innerHTML;
    const originalContents = document.body.innerHTML;

    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
    window.location.reload();
  }
</script>

{% endblock %}
